"Controle_Presença As screen.'phoneDetailEditLayout_ver3.0'":
    Fill: =RGBA(232, 232, 232, 1)
    OnVisible: |-
        =UpdateContext({ varPisca: false });
        // 1. BUSCA O REGISTRO APENAS UMA VEZ PELO ID EXATO (Muito mais rápido e seguro)
        UpdateContext({ 
            ctxAssistenciaAtual: LookUp(Assistências, 'ID Assistência' = AssistenciaSelecionada) 
        });
        
        // 2. AGRUPA A CRIAÇÃO DE VARIÁVEIS PARA EVITAR TRAVAMENTOS NA TELA
        Concurrent(
            // Reseta popups
            UpdateContext({
                MostraPopUp: false,
                PopupConfirmaEnvioDialogo: false,
                PopupConfirmaExcedente: false,
                PopUpConfirmaPresença: false,
                PopupDialogoSemanaQueVem: false,
                PopupDataMesmoDia: false
            }),
            
            // Reseta flags de validação
            Set(Assist_Encerrada, false),
            Set(Assist_fora_dia, false),
            Set(Assist_fora_prazo, false),
            Set(Assist_mesmo_dia, false),
            Set(Semana1, false), Set(Semana2, false), Set(Semana3, false), Set(Semana4, false)
        );
        
        // 3. DEFINE VARIÁVEIS BASEADAS NO REGISTRO
        Concurrent(
            Set(Assist_Encerrada, ctxAssistenciaAtual.Finalizada = "Sim"),
            Set(Assist_fora_dia, Text(ctxAssistenciaAtual.'Dia Semana') <> DiaComPeriodo),
            Set(AssistenciaAtual, ctxAssistenciaAtual.'Assistência (cr4f5_assistencia)'),
            Set(DataEntrevistaAtual, ctxAssistenciaAtual.'Data Entrevista')
        );
        
        // 4. IDENTIFICA A SEMANA ATUAL
        Switch(true,
            IsBlank(ctxAssistenciaAtual.'Semana 1'), Set(Semana1, true),
            IsBlank(ctxAssistenciaAtual.'Semana 2'), Set(Semana2, true),
            IsBlank(ctxAssistenciaAtual.'Semana 3'), Set(Semana3, true),
            IsBlank(ctxAssistenciaAtual.'Semana 4'), Set(Semana4, true)
        );
        
        // 5. VALIDAÇÕES DE DATA (Usando a função 'With' para não gastar memória com mais variáveis)
        With(
            {
                // Calcula a diferença de dias apenas uma vez na memória
                diasS1: DateDiff(ctxAssistenciaAtual.'Semana 1', Now(), TimeUnit.Days),
                diasS2: DateDiff(ctxAssistenciaAtual.'Semana 2', Now(), TimeUnit.Days),
                diasS3: DateDiff(ctxAssistenciaAtual.'Semana 3', Now(), TimeUnit.Days)
            },
            If(
                Semana1,
                Set(Assist_fora_prazo, DateDiff(ctxAssistenciaAtual.'Data Entrevista', Now(), TimeUnit.Days) > tolerancia * 7),
                
                Semana2,
                Set(Assist_fora_prazo, diasS1 > tolerancia * 7);
                Set(Assist_mesmo_dia, diasS1 < 1),
                
                Semana3,
                Set(Assist_fora_prazo, diasS2 > tolerancia * 7);
                Set(Assist_mesmo_dia, diasS2 < 1),
                
                Semana4,
                Set(Assist_fora_prazo, diasS3 > tolerancia * 7);
                Set(Assist_mesmo_dia, diasS3 < 1)
            )
        );
        /*
        //Variáveis para assistência encerrada, fora do dia, fora do prazo ou mesmo dia
        Set(Assist_Encerrada,  false);
        Set(Assist_fora_dia,   false);
        Set(Assist_fora_prazo, false);
        Set(Assist_mesmo_dia,  false);
        
        // Traz o registro apenas UMA vez para a memória
        UpdateContext({ ctxAssistenciaAtual: LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada) });
        
        Set(Assist_Encerrada, ctxAssistenciaAtual.Finalizada = "Sim");
        Set(Assist_fora_dia, Text(ctxAssistenciaAtual.'Dia Semana') <> DiaComPeriodo);
        Set(AssistenciaAtual, ctxAssistenciaAtual.'Assistência (cr4f5_assistencia)');
        Set(DataEntrevistaAtual, ctxAssistenciaAtual.'Data Entrevista');
        
        //Exibição dos campos de data:
        Set(Semana1, false);
        Set(Semana2, false);
        Set(Semana3, false);
        Set(Semana4, false);
        
        UpdateContext({ registroAssistencia: LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada) });
        Switch(true,
            IsBlank(registroAssistencia.'Semana 1'), Set(Semana1, true),
            IsBlank(registroAssistencia.'Semana 2'), Set(Semana2, true),
            IsBlank(registroAssistencia.'Semana 3'), Set(Semana3, true),
            IsBlank(registroAssistencia.'Semana 4'), Set(Semana4, true)
        );
        
        //Validações de data
        //Compara com a data do sistema e não com a data da caixa de data
        //Fora do prazo 1a semana
        If(Semana1,
            Set(
                Assist_fora_prazo,
                DateDiff(registroAssistencia.'Data Entrevista', Now()) > tolerancia * 7
            )
        );
        // Na primeira semana não compara com data entrevista, senão não registra presença no mesmo dia da entrevista
        
        //Fora do prazo 2a semana
        If(Semana2,
            UpdateContext({diasDesdeSemana1: DateDiff(registroAssistencia.'Semana 1', Now())});
            Set(Assist_fora_prazo, diasDesdeSemana1 > tolerancia * 7);
            Set(Assist_mesmo_dia, diasDesdeSemana1 < 1);
        );
        
        //Fora do prazo 3a semana
        If(Semana3,
            UpdateContext({diasDesdeSemana2: DateDiff(registroAssistencia.'Semana 2', Now())});
            Set(Assist_fora_prazo, diasDesdeSemana2 > tolerancia * 7);
            Set(Assist_mesmo_dia, diasDesdeSemana2 < 1);
        );
        
        //Fora do prazo 4a semana
        If(Semana4,
            UpdateContext({diasDesdeSemana3: DateDiff(registroAssistencia.'Semana 3', Now())});
            Set(Assist_fora_prazo, diasDesdeSemana3 > tolerancia * 7);
            Set(Assist_mesmo_dia, diasDesdeSemana3 < 1);
        );
        
        UpdateContext(
            {MostraPopUp: false,
            PopupConfirmaEnvioDialogo: false,
            PopupConfirmaExcedente: false,
            PopUpConfirmaPresença: false,
            PopupDialogoSemanaQueVem: false,
            PopupDataMesmoDia: false
            }
        );
        */

    HTML_Assistencia As htmlViewer:
        BorderColor: =RGBA(0, 89, 178, 1)
        BorderStyle: =BorderStyle.Solid
        BorderThickness: =2
        Color: =RGBA(0, 89, 178, 1)
        Fill: |-
            =If(
                AssistenciaAtual in ["C3", "C3/C2"],
                If(
                    varPisca,
                    Color.Yellow,
                    RGBA(255, 255, 0, 0.2)
                ),
                RGBA(255, 255, 255, 0)
            )
            //RGBA(255, 255, 255, 0)
        Height: =60
        HtmlText: |
            =//"Exiba seu texto <b><font color=blue>HTML</font></b> aqui."
            "<div style='display: flex; justify-content: center; align-items: center;'>
                <b>Assistência: " & AssistenciaAtual & "</b>
            </div>"
            //"<div style='text-align: center;'>
            //    <b>Assistência: " & AssistenciaAtual & "</b>
            //</div>"
        Size: =24
        Width: =450
        X: =Parent.Width/2 - Self.Width/2
        Y: =Form_Controle.Height + Form_Controle.Y
        ZIndex: =1

    RectQuickActionBar3_3 As rectangle:
        BorderColor: =RGBA(0, 89, 178, 1)
        Fill: =RGBA(0, 51, 102, 1)
        Height: =88
        Width: =Parent.Width
        ZIndex: =2

    Icone_Cancela_Controle As icon.Cancel:
        AccessibleLabel: =Self.Tooltip
        BorderColor: =RGBA(0, 89, 178, 1)
        Color: =RGBA(255, 255, 255, 1)
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(244, 244, 244, 1)
        Height: =88
        Icon: =Icon.CancelBadge
        OnSelect: |-
            =ResetForm(Form_Controle);
            UpdateContext({ MostraPopUp: false });
            Back()
        PaddingBottom: =22
        PaddingLeft: =22
        PaddingRight: =22
        PaddingTop: =22
        PressedFill: =RGBA(255, 255, 255, 0.3)
        TabIndex: =0
        Tooltip: ="Cancel item"
        Width: =88
        ZIndex: =3

    Icone_Salva_Controle As icon.Check:
        AccessibleLabel: =Self.Tooltip
        BorderColor: =RGBA(0, 89, 178, 1)
        Color: =RGBA(255, 255, 255, 1)
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(244, 244, 244, 1)
        Height: =88
        Icon: =Icon.Save
        OnSelect: =
        PaddingBottom: =22
        PaddingLeft: =22
        PaddingRight: =22
        PaddingTop: =22
        PressedFill: =RGBA(255, 255, 255, 0.3)
        TabIndex: =0
        Tooltip: ="Submit item"
        Visible: =false
        Width: =88
        X: =Parent.Width - Self.Width
        ZIndex: =4

    LblAppName3_3 As label:
        Color: =RGBA(255, 255, 255, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Fill: =RGBA(58, 58, 58, 0)
        Height: =88
        Size: =27
        Text: ="Controle Frequência"
        Width: =Parent.Width - Icone_Cancela_Controle.Width - Icone_Salva_Controle.Width
        Wrap: =false
        X: =80
        ZIndex: =5

    Form_Controle As form:
        BorderColor: =RGBA(0, 89, 178, 1)
        DataSource: =Assistências
        Height: ='Numero do Assistido'.Height + Data_Entrevista.Height + 'Dia Semana'.Height + Semana_1.Height + Semana_2.Height + Semana_3.Height + Semana_4.Height + 'Presencas Extras'.Height
        Item: |-
            =ctxAssistenciaAtual//LookUp(Assistências, 'ID Assistência' = AssistenciaSelecionada)
            //LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada)
        OnSuccess: =
        Width: =Parent.Width
        Y: =RectQuickActionBar3_3.Height + 1
        ZIndex: =6

        "'Numero do Assistido' As typedDataCard.textualViewCard":
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_idpessoa"
            Default: =ThisItem.'ID Pessoa'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'ID Pessoa')
            Fill: =RGBA(0, 0, 0, 0)
            Height: =110
            Required: =true
            Width: =Parent.Width
            X: =0
            Y: =0
            ZIndex: =1

            DataCardKey107 As label:
                Align: =Align.Center
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =54
                Size: =24
                Text: ="Número do Assistido"
                Width: =Parent.Width
                Y: =10
                ZIndex: =1

            DataCardValue49 As label:
                Align: =Align.Center
                AutoHeight: =true
                BorderColor: =RGBA(0, 89, 178, 1)
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisplayMode: =Parent.DisplayMode
                FontWeight: =FontWeight.Bold
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =24
                Text: =Parent.Default
                Width: =Parent.Width
                Y: =DataCardKey107.Height + DataCardKey107.Y
                ZIndex: =2

            "'Borda Texto Numero Assistido_1' As button":
                BorderColor: |-
                    =//ColorFade(Self.Fill; -15%)
                    RGBA(0, 89, 178, 1)
                BorderThickness: =3
                DisabledBorderColor: =RGBA(166, 166, 166, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                Fill: =RGBA(0, 0, 0, 0)
                FontWeight: =FontWeight.Semibold
                Height: =Parent.Height - 3
                HoverColor: =RGBA(255, 255, 255, 1)
                HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
                Size: =24
                Text: =
                Width: =Parent.Width * 0.5
                X: =Parent.Width/2 - Self.Width/2
                Y: =2
                ZIndex: =3

        Data_Entrevista As typedDataCard.textualViewCard:
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_dataentrevista"
            Default: =ThisItem.'Data Entrevista'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Data Entrevista')
            Fill: =RGBA(0, 0, 0, 0)
            Height: =65
            Required: =false
            Width: =Parent.Width
            X: =0
            Y: =1
            ZIndex: =2

            DataCardKey108 As label:
                AutoHeight: =true
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Size: =21
                Text: ="Data da Entrevista"
                Width: =(Parent.Width - 40) * 0.5
                X: =20
                Y: =Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DataCardValue81 As label:
                AutoHeight: =true
                BorderColor: =RGBA(0, 89, 178, 1)
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisplayMode: =Parent.DisplayMode
                Height: =42
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Concatenate(Text(ThisItem.'Data Entrevista', "dd-mmm-yyyy", "pt-br")," - ",Proper(Text(ThisItem.'Data Entrevista',"ddd")))
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey108.X + DataCardKey108.Width + 20
                Y: =Parent.Height/2 - Self.Height/2
                ZIndex: =2

        "'Dia Semana' As typedDataCard.textualViewCard":
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_diasemana"
            Default: =ThisItem.'Dia Semana'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Dia Semana')
            Fill: =RGBA(0, 0, 0, 0)
            Height: =40
            Required: =true
            Width: =720
            X: =0
            Y: =2
            ZIndex: =3

            DataCardKey7 As label:
                AutoHeight: =true
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =48
                Size: =21
                Text: =Parent.DisplayName
                Width: =(Parent.Width - 40) * 0.5
                Wrap: =false
                X: =20
                Y: =Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DataCardValue7 As label:
                AutoHeight: =true
                BorderColor: =RGBA(0, 89, 178, 1)
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisplayMode: =Parent.DisplayMode
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Parent.Default
                Width: =(Parent.Width - 60) * 0.6
                X: =DataCardKey7.X + DataCardKey7.Width + 20
                Y: =10
                ZIndex: =2

        Semana_1 As typedDataCard.dateTimeEditCard:
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_semana1"
            Default: =ThisItem.'Semana 1'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Semana 1')
            Fill: |-
                =If(Semana1 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                    Color.LightGreen,
                    Color.Transparent
                )
                //If(Semana1;Color.PaleGoldenRod;Color.Transparent)
            Height: =65
            Required: =false
            Update: =DateValue4.SelectedDate
            Width: =Parent.Width
            X: =0
            Y: =3
            ZIndex: =4

            DataCardKey50 As label:
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =50
                Size: =21
                Text: ="1ª Semana"
                Width: =(Parent.Width - 40) * 0.5
                X: =20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DateValue4 As datepicker:
                BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                CalendarHeaderFill: =RGBA(0, 51, 102, 1)
                Color: =RGBA(0, 0, 0, 1)
                DefaultDate: |-
                    =If(Semana1 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Now(),
                        Parent.Default
                    )
                DisabledBorderColor: =RGBA(166, 166, 166, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =Parent.DisplayMode
                EndYear: =Year(Today())+100
                Fill: |-
                    =If(Semana1 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Color.LightGreen,
                        Color.Transparent
                    )
                    //If(Semana1;Color.PaleGoldenRod;Color.Transparent)
                Height: =50
                HoverDateFill: =RGBA(153, 205, 255, 1)
                IconBackground: =RGBA(0, 51, 102, 1)
                InputTextPlaceholder: =Self.SelectedDate
                IsEditable: =true
                PaddingBottom: =0
                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                SelectedDateFill: =RGBA(0, 51, 102, 1)
                Size: =21
                StartYear: =2023
                Tooltip: =Parent.DisplayName
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey50.X + DataCardKey50.Width + 20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =2

            ErrorMessage41 As label:
                AutoHeight: =true
                Color: =RGBA(168, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Semibold
                Height: =10
                Live: =Live.Assertive
                PaddingBottom: =0
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Parent.Error
                Visible: =Parent.DisplayMode=DisplayMode.Edit
                Width: =Parent.Width - 60
                X: =30
                Y: =DateValue4.Y + DateValue4.Height
                ZIndex: =3

            StarVisible41 As label:
                Align: =Align.Center
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Height: =DataCardKey50.Height
                Size: =19
                Text: ="*"
                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                Width: =30
                Wrap: =false
                Y: =DataCardKey50.Y
                ZIndex: =4

        Semana_2 As typedDataCard.dateTimeEditCard:
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_semana2"
            Default: =ThisItem.'Semana 2'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Semana 2')
            Fill: |-
                =If(Semana2 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                    Color.LightGreen,
                    Color.Transparent
                )
                //If(Semana2;Color.PaleGoldenRod;Color.Transparent)
            Height: =65
            Required: =false
            Update: =DateValue5.SelectedDate
            Width: =Parent.Width
            X: =0
            Y: =4
            ZIndex: =5

            DataCardKey51 As label:
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =50
                Size: =21
                Text: ="2ª Semana"
                Width: =(Parent.Width - 40) * 0.5
                Wrap: =false
                X: =20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DateValue5 As datepicker:
                BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                CalendarHeaderFill: =RGBA(0, 51, 102, 1)
                Color: =RGBA(0, 0, 0, 1)
                DefaultDate: |-
                    =If(Semana2 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Now(),
                        Parent.Default
                    )
                DisabledBorderColor: =RGBA(166, 166, 166, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =Parent.DisplayMode
                EndYear: =Year(Today())+100
                Fill: |-
                    =If(Semana2 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Color.LightGreen,
                        Color.Transparent
                    )
                    //If(Semana2;Color.PaleGoldenRod;Color.Transparent)
                Height: =50
                HoverDateFill: =RGBA(153, 205, 255, 1)
                IconBackground: =RGBA(0, 51, 102, 1)
                InputTextPlaceholder: =Self.SelectedDate
                IsEditable: =true
                PaddingBottom: =0
                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                SelectedDateFill: =RGBA(0, 51, 102, 1)
                Size: =21
                StartYear: =1899
                Tooltip: =Parent.DisplayName
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey51.X + DataCardKey51.Width + 20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =2

            ErrorMessage42 As label:
                AutoHeight: =true
                Color: =RGBA(168, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Semibold
                Height: =10
                Live: =Live.Assertive
                PaddingBottom: =0
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Parent.Error
                Visible: =Parent.DisplayMode=DisplayMode.Edit
                Width: =Parent.Width - 60
                X: =30
                Y: =DateValue5.Y + DateValue5.Height
                ZIndex: =3

            StarVisible42 As label:
                Align: =Align.Center
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Height: =DataCardKey51.Height
                Size: =19
                Text: ="*"
                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                Width: =30
                Wrap: =false
                Y: =DataCardKey51.Y
                ZIndex: =4

        Semana_3 As typedDataCard.dateTimeEditCard:
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_semana3"
            Default: =ThisItem.'Semana 3'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Semana 3')
            Fill: |-
                =If(Semana3 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                    Color.LightGreen,
                    Color.Transparent
                )
                //If(Semana3;Color.PaleGoldenRod;Color.Transparent)
            Height: =65
            Required: =false
            Update: =DateValue6.SelectedDate
            Width: =Parent.Width
            X: =0
            Y: =5
            ZIndex: =6

            DataCardKey52 As label:
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =50
                Size: =21
                Text: ="3ª Semana"
                Width: =(Parent.Width - 40) * 0.5
                Wrap: =false
                X: =20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DateValue6 As datepicker:
                BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                CalendarHeaderFill: =RGBA(0, 51, 102, 1)
                Color: =RGBA(0, 0, 0, 1)
                DefaultDate: |-
                    =If(Semana3 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Now(),
                        Parent.Default
                    )
                DisabledBorderColor: =RGBA(166, 166, 166, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =Parent.DisplayMode
                EndYear: =Year(Today())+100
                Fill: |-
                    =If(Semana3 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Color.LightGreen,
                        Color.Transparent
                    )
                    //If(Semana3;Color.PaleGoldenRod;Color.Transparent)
                Height: =50
                HoverDateFill: =RGBA(153, 205, 255, 1)
                IconBackground: =RGBA(0, 51, 102, 1)
                InputTextPlaceholder: =Self.SelectedDate
                IsEditable: =true
                PaddingBottom: =0
                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                SelectedDateFill: =RGBA(0, 51, 102, 1)
                Size: =21
                StartYear: =1899
                Tooltip: =Parent.DisplayName
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey52.X + DataCardKey52.Width + 20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =2

            ErrorMessage44 As label:
                AutoHeight: =true
                Color: =RGBA(168, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Semibold
                Height: =10
                Live: =Live.Assertive
                PaddingBottom: =0
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =24
                Text: =Parent.Error
                Visible: =Parent.DisplayMode=DisplayMode.Edit
                Width: =Parent.Width - 60
                X: =30
                Y: =DateValue6.Y + DateValue6.Height
                ZIndex: =3

            StarVisible44 As label:
                Align: =Align.Center
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Height: =DataCardKey52.Height
                Size: =19
                Text: ="*"
                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                Width: =30
                Wrap: =false
                Y: =DataCardKey52.Y
                ZIndex: =4

        Semana_4 As typedDataCard.dateTimeEditCard:
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_semana4"
            Default: =ThisItem.'Semana 4'
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,'Semana 4')
            Fill: |-
                =If(Semana4 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                    Color.LightGreen,
                    Color.Transparent
                )
                //If(Semana4;Color.PaleGoldenRod;Color.Transparent)
            Height: =65
            Required: =false
            Update: =DateValue7.SelectedDate
            Visible: =true
            Width: =Parent.Width
            X: =0
            Y: =6
            ZIndex: =7

            DataCardKey53 As label:
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Bold
                Height: =50
                Size: =21
                Text: ="4ª Semana"
                Width: =(Parent.Width - 40) * 0.5
                Wrap: =false
                X: =20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DateValue7 As datepicker:
                BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                CalendarHeaderFill: =RGBA(0, 51, 102, 1)
                Color: =RGBA(0, 0, 0, 1)
                DefaultDate: |-
                    =If(Semana4 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Now(),
                        Parent.Default
                    )
                DisabledBorderColor: =RGBA(166, 166, 166, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =Parent.DisplayMode
                EndYear: =Year(Today())+100
                Fill: |-
                    =If(Semana4 && !Assist_Encerrada && !Assist_fora_dia && !Assist_fora_prazo && !Assist_mesmo_dia,
                        Color.LightGreen,
                        Color.Transparent
                    )
                    //If(Semana4;Color.PaleGoldenRod;Color.Transparent)
                Height: =50
                HoverDateFill: =RGBA(153, 205, 255, 1)
                IconBackground: =RGBA(0, 51, 102, 1)
                InputTextPlaceholder: =Self.SelectedDate
                IsEditable: =true
                PaddingBottom: =0
                PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                SelectedDateFill: =RGBA(0, 51, 102, 1)
                Size: =21
                StartYear: =1899
                Tooltip: =Parent.DisplayName
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey53.X + DataCardKey53.Width + 20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =2

            ErrorMessage45 As label:
                AutoHeight: =true
                Color: =RGBA(168, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                FontWeight: =FontWeight.Semibold
                Height: =10
                Live: =Live.Assertive
                PaddingBottom: =0
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Parent.Error
                Visible: =Parent.DisplayMode=DisplayMode.Edit
                Width: =Parent.Width - 60
                X: =30
                Y: =DateValue7.Y + DateValue7.Height
                ZIndex: =3

            StarVisible45 As label:
                Align: =Align.Center
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Height: =DataCardKey53.Height
                Size: =19
                Text: ="*"
                Visible: =And(Parent.Required, Parent.DisplayMode=DisplayMode.Edit)
                Width: =30
                Wrap: =false
                Y: =DataCardKey53.Y
                ZIndex: =4

        "'Presencas Extras' As typedDataCard.textualViewCard":
            BorderColor: =RGBA(0, 89, 178, 1)
            BorderStyle: =BorderStyle.Solid
            DataField: ="cr4f5_extra"
            Default: =ThisItem.Extra
            DisplayMode: =DisplayMode.View
            DisplayName: =DataSourceInfo([@Assistências],DataSourceInfo.DisplayName,Extra)
            Fill: =RGBA(0, 0, 0, 0)
            Height: =65
            Required: =false
            Width: =Parent.Width
            X: =0
            Y: =7
            ZIndex: =8

            DataCardKey9 As label:
                AutoHeight: =true
                Color: =RGBA(0, 89, 178, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisplayMode: =DisplayMode.View
                FontWeight: =FontWeight.Bold
                Height: =50
                Size: =21
                Text: |-
                    =//Parent.DisplayName
                    "Presenças Extras:"
                Width: =(Parent.Width - 40) * 0.5
                X: =20
                Y: |-
                    =//10
                    Parent.Height/2 - Self.Height/2
                ZIndex: =1

            DataCardValue9 As label:
                AutoHeight: =true
                BorderColor: =RGBA(0, 89, 178, 1)
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisplayMode: =Parent.DisplayMode
                Height: =50
                PaddingLeft: =0
                PaddingRight: =0
                PaddingTop: =0
                Size: =21
                Text: =Parent.Default
                Width: =(Parent.Width - 40) * 0.5
                X: =DataCardKey9.X + DataCardKey9.Width + 20
                Y: |-
                    =//25
                    Parent.Height/2 - Self.Height/2
                ZIndex: =2

    Lbl_Mensagem As label:
        Align: =Align.Center
        BorderColor: =RGBA(0, 89, 178, 1)
        Color: =If("Fora" in Self.Text Or "encerrada" in Self.Text Or "realizou" in Self.Text,Color.Yellow,Color.WhiteSmoke)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Fill: =If("Fora" in Self.Text Or "encerrada" in Self.Text Or "realizou" in Self.Text,Color.Red,Color.Green)
        FontWeight: =If("Fora" in Self.Text Or "encerrada" in Self.Text Or "realizou" in Self.Text, FontWeight.Bold,FontWeight.Normal)
        Height: =70
        Size: =21
        Text: |-
            =If(
                Assist_Encerrada, "Assistencia encerrada, encaminhar para diálogo",
                Assist_fora_dia, "Assistido fora do dia de atendimento",
                Assist_fora_prazo, "Assistido fora do prazo, encaminhar para diálogo",
                Assist_mesmo_dia, "Assistido já realizou a Assistência desta semana",
                "Liberado para assistência"
            )
            /*
            If(Assist_Encerrada=true,"Assistencia encerrada, encaminhar para diálogo",
                (Assist_fora_dia=true),"Assistido fora do dia de atendimento",
                    (Assist_fora_prazo=true),"Assistido fora do prazo, encaminhar para diálogo",
                        (Assist_mesmo_dia=true),"Assistido já realizou a Assistência desta semana",
            "Liberado para assistência"
            )*/
        Width: =560
        X: =Parent.Width/2 - Self.Width/2
        Y: =HTML_Assistencia.Height + HTML_Assistencia.Y + ((Parent.Height - HTML_Assistencia.Height - HTML_Assistencia.Y)/4)*(0 + 1/2) - Self.Height/2
        ZIndex: =7

    Btn_Confirma_Assistência As button:
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Fill: =RGBA(0, 51, 102, 1)
        FocusedBorderColor: =ColorFade(Self.Fill, -75%)
        FontWeight: =FontWeight.Semibold
        Height: =80
        HoverColor: =RGBA(255, 255, 255, 1)
        HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
        OnSelect: |-
            =UpdateContext({ PopUpConfirmaPresença: true })
        Size: =24
        Text: ="Confirma Assistência"
        Visible: |-
            =If(Assist_Encerrada=false And Assist_fora_dia=false And Assist_fora_prazo=false And Assist_mesmo_dia=false, 
                true,
                false
            )
        Width: =380
        X: =Parent.Width/2 - Self.Width/2
        Y: |-
            =Form_Controle.Height + Form_Controle.Y + ((Parent.Height - Form_Controle.Height - Form_Controle.Y)/4)*(1
             + 1/2) - Self.Height/2
        ZIndex: =8

    Btn_Confirma_Envio_Dialogo As button:
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Fill: =RGBA(0, 51, 102, 1)
        FocusedBorderColor: =ColorFade(Self.Fill, -75%)
        FontWeight: =FontWeight.Semibold
        Height: =80
        HoverColor: =RGBA(255, 255, 255, 1)
        HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
        OnSelect: |-
            =If(
                DateValue(DataEntrevistaAtual) = Today(),
                UpdateContext({PopupDataMesmoDia: true}),
                UpdateContext({PopupConfirmaEnvioDialogo: true})
                //Set(TextoPopUpDialogo, ""),
                //Set(TextoPopUpDialogo, "Deseja confirmar o Diálogo no dia de hoje?")
            );
            //UpdateContext({PopupConfirmaEnvioDialogo: true})
        Size: =24
        Text: ="Enviar p/ Diálogo"
        Visible: |-
            =//If(Assist_Encerrada=false And Assist_fora_dia=false And Assist_fora_prazo=true And Assist_mesmo_dia=false; 
            //    true;
            //    false
            //)
            //If(Assist_Encerrada=true Or Assist_mesmo_dia=true; 
            //    false;
            //    true
            //)
            true
        Width: =380
        X: =Parent.Width/2 - Self.Width/2
        Y: =Form_Controle.Height + Form_Controle.Y + ((Parent.Height - Form_Controle.Height - Form_Controle.Y)/4)*(2 + 1/2) - Self.Height/2
        ZIndex: =9

    Btn_Registra_Excedente As button:
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Fill: =RGBA(0, 51, 102, 1)
        FocusedBorderColor: =ColorFade(Self.Fill, -75%)
        FontWeight: =FontWeight.Semibold
        Height: =80
        HoverColor: =RGBA(255, 255, 255, 1)
        HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
        OnSelect: |-
            =UpdateContext({PopupConfirmaExcedente: true});
        Size: =24
        Text: ="Registra Extra?"
        Visible: |
            =(Assist_Encerrada || Assist_fora_dia || Assist_fora_prazo)
        Width: =380
        X: =Parent.Width/2 - Self.Width/2
        Y: |-
            =Form_Controle.Height + Form_Controle.Y + ((Parent.Height - Form_Controle.Height - Form_Controle.Y)/4)*(3
             + 1/2) - Self.Height/2
        ZIndex: =10

    Fundo_Popup As rectangle:
        BorderColor: =RGBA(0, 89, 178, 1)
        Fill: =RGBA(100, 118, 132, 0.6)
        Height: =Parent.Height - RectQuickActionBar3_3.Height
        Visible: =MostraPopUp Or PopupConfirmaEnvioDialogo Or PopupConfirmaExcedente Or PopupDialogoSemanaQueVem Or PopupDataMesmoDia
        Width: =Parent.Width
        Y: =88
        ZIndex: =11

    Popup_Confirma_Presença As group:
        Height: =5
        Width: =5
        X: =60
        Y: =60
        ZIndex: =18

        Retangulo_Popup_Confirma_Presença As rectangle:
            BorderColor: =RGBA(0, 89, 178, 1)
            Fill: =Color.White
            Height: =281
            Visible: =PopUpConfirmaPresença
            Width: =464
            X: =Parent.Width/2 - Self.Width/2
            Y: =428
            ZIndex: =26

        lbl_Aviso_popup_Confirma_Presença As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(255, 255, 255, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =Color.Red
            FontWeight: =FontWeight.Bold
            Height: =72
            Size: =21
            Text: ="Aviso"
            Visible: =PopUpConfirmaPresença
            Width: =Retangulo_Popup_Confirma_Presença.Width
            X: =Retangulo_Popup_Confirma_Presença.X
            Y: =428
            ZIndex: =27

        lbl_Texto_popup_Confirma_Presença As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Height: =84
            Size: =21
            Text: ="Deseja confirmar a presença no dia de hoje?"
            Visible: =PopUpConfirmaPresença
            Width: =Retangulo_Popup_Confirma_Presença.Width
            X: =Retangulo_Popup_Confirma_Presença.X
            Y: =505
            ZIndex: =28

        Btn_Sim_Confirma_Presença As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |
                =SubmitForm(Form_Controle);
                Patch(
                    Logs,
                    Defaults(Logs),
                    {
                        DataeHora: Now(),
                        DeviceID: DeviceID,
                        Ação: "Confirmada Presença ID:" & PessoaSelecionada & " - " & AssistenciaAtual
                    }
                );
                Patch(
                    Assistências,
                    ctxAssistenciaAtual, // Usa a variável que já está na memória!
                    {
                        'Semana 1': If(Semana1, Today(), ctxAssistenciaAtual.'Semana 1'),
                        'Semana 2': If(Semana2, Today(), ctxAssistenciaAtual.'Semana 2'),
                        'Semana 3': If(Semana3, Today(), ctxAssistenciaAtual.'Semana 3'),
                        'Semana 4': If(Semana4, Today(), ctxAssistenciaAtual.'Semana 4'),
                        'Ultimo Comparecimento': Today()
                    }
                );
                /*
                If(Semana1,
                    Patch(Assistências,
                        LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                        {
                            'Semana 1': Today()
                        }
                    )
                );
                If(Semana2,
                    Patch(Assistências,
                        LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                        {
                            'Semana 2': Today()
                        }
                    )
                );
                If(Semana3,
                    Patch(Assistências,
                        LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                        {
                            'Semana 3': Today()
                        }
                    )
                );
                If(Semana4,
                    Patch(Assistências,
                        LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                        {
                            'Semana 4': Today()
                        }
                    )
                );*/
                // 1. Variáveis Iniciais
                Set(Hoje, Text(Today(), "[$-pt-BR]dd/mm/yyyy"));
                
                // 2. Trazemos os dados para a memória APENAS PARA LEITURA
                Set(RegPresençaAtual, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo));
                
                // 3. Se o registro para hoje e esse período ainda não existe, criamos a linha vazia
                If(
                    IsBlank(RegPresençaAtual),
                    Patch(Presenças, Defaults(Presenças), {Data: Hoje, PeriodoDia: Periodo});
                    
                    // Agora que criamos a linha, atualizamos a nossa variável para enxergar ela
                    Set(RegPresençaAtual, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo))
                );
                
                // 4. Fazemos a soma e atualizamos o banco.
                // NOTA: No 2º argumento usamos o LookUp (evita o erro do Dataverse).
                // No 3º argumento usamos a Variável + Value() (Deixa muito rápido e dispensa dezenas de IsBlanks).
                Switch(
                    AssistenciaAtual,
                    "A1", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {A1: Value(RegPresençaAtual.A1) + 1}),
                    "A2", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {A2: Value(RegPresençaAtual.A2) + 1}),
                    "A3", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {A3: Value(RegPresençaAtual.A3) + 1}),
                    "C1", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {C1: Value(RegPresençaAtual.C1) + 1}),
                    "C2", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {C2: Value(RegPresençaAtual.C2) + 1}),
                    "C3", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {C3: Value(RegPresençaAtual.C3) + 1}),
                    
                    // Casos Duplos
                    "A3/A1", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegPresençaAtual.A3) + 1,
                        A1: Value(RegPresençaAtual.A1) + 1
                    }),
                    "C3/C1", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {
                        C3: Value(RegPresençaAtual.C3) + 1,
                        C1: Value(RegPresençaAtual.C1) + 1
                    }),
                    "A3/A2", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegPresençaAtual.A3) + 1,
                        A2: Value(RegPresençaAtual.A2) + 1
                    }),
                    "C3/C2", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {
                        C3: Value(RegPresençaAtual.C3) + 1,
                        C2: Value(RegPresençaAtual.C2) + 1
                    }),
                    "A3/A2-Casa", Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegPresençaAtual.A3) + 1
                    })
                );
                /*
                // Registra na tabela Presenças na data e assistência atual
                // Verificar se a data atual já existe na tabela Presenças
                Set(Hoje, Text(Today(), "[$-pt-BR]dd/mm/yyyy"));
                
                Set(ExistingRecord, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo));
                
                // Se não existir, criar um novo registro
                If(
                    IsBlank(ExistingRecord),
                    Patch(Presenças, Defaults(Presenças), {Data: Hoje, PeriodoDia: Periodo})
                );
                
                If(
                    AssistenciaAtual = "A1",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A1: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A1), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A1 + 1)}),
                    AssistenciaAtual = "A2",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A2: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A2), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A2 + 1)}),
                    AssistenciaAtual = "A3",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3 + 1)}),
                    AssistenciaAtual = "C1",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {C1: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C1), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C1 + 1)}),
                    AssistenciaAtual = "C2",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {C2: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C2), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C2 + 1)}),
                    AssistenciaAtual = "C3",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3 + 1)}),
                    AssistenciaAtual = "A3/A1",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3 + 1),
                             A1: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A1), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A1 + 1)}),
                    AssistenciaAtual = "C3/C1",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3 + 1),
                            C1: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C1), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C1 + 1)}),
                    AssistenciaAtual = "A3/A2",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3 + 1),
                             A2: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A2), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A2 + 1)}),
                    AssistenciaAtual = "C3/C2",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C3 + 1),
                            C2: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C2), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).C2 + 1)}),
                    AssistenciaAtual = "A3/A2-Casa",
                    Patch(Presenças, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Presenças, Data = Hoje && PeriodoDia = Periodo).A3 + 1)})
                );
                */
                //Salva na tabela Pessoas a data atual na coluna 'Ultima Assistência' (para poder fazer a
                //limpeza por tempo que não comparece à assistência.
                Patch(
                    Pessoas,
                    LookUp(
                        Pessoas,
                        'ID Pessoa' = PessoaSelecionada
                    ),
                    {'Ultima Assistência': Today()}
                );
                
                //Salva na tabela Assistências a data atual na coluna 'Ultimo Comparecimento' (para poder
                //fazer a limpeza por tempo que não comparece à assistência.
                Patch(
                    Assistências,
                    LookUp(
                        Assistências,
                        'ID Assistência' = AssistenciaSelecionada
                    ),
                    {'Ultimo Comparecimento': Today()}
                );
                
                UpdateContext({PopUpConfirmaPresença: false});
                If(
                    Semana4,
                    UpdateContext({PopupDialogoSemanaQueVem: true}),
                    UpdateContext({PopupDialogoSemanaQueVem: false}) && Back()
                );
            Size: =24
            Text: ="Sim"
            Visible: =PopUpConfirmaPresença
            Width: =157
            X: =Retangulo_Popup_Confirma_Presença.X + (Retangulo_Popup_Confirma_Presença.Width/4)*3 - Self.Width/2
            Y: =630
            ZIndex: =29

        Btn_Nao_Confirma_Presença As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |-
                =UpdateContext({ PopUpConfirmaPresença: false })
            Size: =24
            Text: ="Não"
            Visible: =PopUpConfirmaPresença
            Width: =157
            X: =Retangulo_Popup_Confirma_Presença.X + (Retangulo_Popup_Confirma_Presença.Width/4) - Self.Width/2
            Y: =630
            ZIndex: =30

    Popup_Dialogo_Semana_que_vem As group:
        Height: =5
        Width: =5
        X: =20
        Y: =20
        ZIndex: =23

        Retangulo_Popup_Dialogo_Semana_que_vem As rectangle:
            BorderColor: =RGBA(0, 89, 178, 1)
            Fill: =Color.White
            Height: =281
            Visible: =PopupDialogoSemanaQueVem
            Width: =464
            X: =Parent.Width/2 - Self.Width/2
            Y: =428
            ZIndex: =22

        lbl_Aviso_popup_Dialogo_Semana_que_vem As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 134, 208, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =RGBA(255, 255, 0, 1)
            FontWeight: =FontWeight.Bold
            Height: =72
            Size: =21
            Text: ="ATENÇÃO"
            Visible: =PopupDialogoSemanaQueVem
            Width: =464
            X: =Retangulo_Popup_Dialogo_Semana_que_vem.X
            Y: =429
            ZIndex: =23

        lbl_Texto_popup_Dialogo_Semana_que_vem As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Height: =105
            Size: =21
            Text: ="Assistência encerrada, encaminhar para diálogo na próxima semana"
            Visible: =PopupDialogoSemanaQueVem
            Width: =464
            X: =Retangulo_Popup_Dialogo_Semana_que_vem.X
            Y: =505
            ZIndex: =24

        Btn_Ok_Dialogo_Semana_que_vem As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |
                =Patch(
                    Assistências,
                    LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                    {
                        Finalizada: "Sim"
                    }
                );
                
                Patch(
                    Logs,
                    Defaults(Logs),
                    {
                        DataeHora: Now(),
                        DeviceID: DeviceID,
                        Ação: "Dialogo Próxima Semana ID:" & PessoaSelecionada
                    }
                );
                
                UpdateContext({PopupDialogoSemanaQueVem: false});
                UpdateContext({PopUpConfirmaPresença: false});
                
                Back();
            Size: =24
            Text: ="Ok"
            Visible: =PopupDialogoSemanaQueVem
            Width: =157
            X: =Parent.Width/2 - Self.Width/2
            Y: =632
            ZIndex: =25

    Popup_Confirma_Envio_Dialogo As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =28

        Retangulo_Popup_Confirma_Envio_Dialogo As rectangle:
            BorderColor: =RGBA(0, 89, 178, 1)
            Fill: =Color.White
            Height: =281
            Visible: =PopupConfirmaEnvioDialogo
            Width: =464
            X: =Parent.Width/2 - Self.Width/2
            Y: =428
            ZIndex: =12

        lbl_Aviso_popup_Confirma_Envio_Dialogo As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(255, 255, 255, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =Color.Red
            FontWeight: =FontWeight.Bold
            Height: =72
            Size: =21
            Text: ="Aviso"
            Visible: =PopupConfirmaEnvioDialogo
            Width: =Retangulo_Popup_Confirma_Envio_Dialogo.Width
            X: =Parent.Width/2 - Self.Width/2
            Y: =428
            ZIndex: =13

        lbl_Texto_popup_Confirma_Envio_Dialogo As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Height: =84
            Size: =21
            Text: ="Deseja confirmar o Diálogo no dia de hoje?"
            Visible: =PopupConfirmaEnvioDialogo
            Width: =Retangulo_Popup_Confirma_Envio_Dialogo.Width
            X: =Parent.Width/2 - Self.Width/2
            Y: =505
            ZIndex: =14

        Btn_Sim_Confirma_Envio_Dialogo As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |
                =
                Patch(Assistências,
                    LookUp(Assistências, 'ID Pessoa' = PessoaSelecionada),
                    {
                        Finalizada: "Sim"
                    }
                );
                
                UpdateContext({PopupConfirmaEnvioDialogo: false});
                
                Set(PessoaSelecionada, PessoaSelecionada);
                
                Patch(
                    Logs,
                    Defaults(Logs),
                    {
                        DataeHora: Now(),
                        DeviceID: DeviceID,
                        Ação: "Confirmada assistência encerrada ID:" & PessoaSelecionada
                    }
                );
                
                Navigate(Infos_Entrevista_Dialogo, ScreenTransition.None);
            Size: =24
            Text: ="Sim"
            Visible: =PopupConfirmaEnvioDialogo
            Width: =157
            X: =Retangulo_Popup_Confirma_Envio_Dialogo.X + (Retangulo_Popup_Confirma_Envio_Dialogo.Width/4)*3 - Self.Width/2
            Y: =630
            ZIndex: =15

        Btn_Nao_Confirma_Envio_Dialogo As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |-
                =UpdateContext({PopupConfirmaEnvioDialogo: false})
            Size: =24
            Text: ="Não"
            Visible: =PopupConfirmaEnvioDialogo
            Width: =157
            X: =Retangulo_Popup_Confirma_Envio_Dialogo.X + (Retangulo_Popup_Confirma_Envio_Dialogo.Width/4) - Self.Width/2
            Y: =630
            ZIndex: =16

    Popup_Confirma_Excedente As group:
        Height: =5
        Width: =5
        X: =20
        Y: =20
        ZIndex: =35

        Retangulo_Popup_Confirma_Envio_Dialogo_1 As rectangle:
            BorderColor: =RGBA(0, 89, 178, 1)
            Fill: =Color.White
            Height: =281
            Visible: =PopupConfirmaExcedente
            Width: =464
            X: =Parent.Width/2 - Self.Width/2
            Y: =428
            ZIndex: =17

        lbl_Aviso_popup_Confirma_Envio_Dialogo_1 As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(255, 255, 255, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =Color.Red
            FontWeight: =FontWeight.Bold
            Height: =72
            Size: =21
            Text: ="Aviso"
            Visible: =PopupConfirmaExcedente
            Width: =464
            X: =Retangulo_Popup_Confirma_Envio_Dialogo_1.X
            Y: =428
            ZIndex: =18

        lbl_Texto_popup_Confirma_Envio_Dialogo_1 As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Height: =84
            Size: =21
            Text: ="Deseja confirmar presença extra para hoje?"
            Visible: =PopupConfirmaExcedente
            Width: =464
            X: =Retangulo_Popup_Confirma_Envio_Dialogo_1.X
            Y: =505
            ZIndex: =19

        Btn_Sim_Confirma_Excedente As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |-
                =//------------------------------------------------------------------------------------------
                //Incrementa excedente do assistido
                Set(Qtde_Nova,LookUp(Assistências,'ID Pessoa'= PessoaSelecionada,Extra)+1);
                
                Patch(Assistências,
                    LookUp(Assistências,'ID Pessoa'= PessoaSelecionada),
                    {Extra: Qtde_Nova}
                );
                //------------------------------------------------------------------------------------------
                
                //------------------------------------------------------------------------------------------
                // Log
                Patch(
                    Logs,
                    Defaults(Logs),
                    {
                        DataeHora: Now(),
                        DeviceID: DeviceID,
                        Ação: "Registrado Excedente ID:" & PessoaSelecionada & " - " & AssistenciaAtual
                    }
                );
                //------------------------------------------------------------------------------------------
                // 1. Variáveis Iniciais
                Set(Hoje, Text(Today(), "[$-pt-BR]dd/mm/yyyy"));
                
                // 2. Trazemos os dados para a memória APENAS PARA LEITURA
                Set(RegExcedenteAtual, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo));
                
                // 3. Se o registro para hoje e esse período ainda não existe, criamos a linha vazia
                If(
                    IsBlank(RegExcedenteAtual),
                    Patch(Excedentes, Defaults(Excedentes), {Data: Hoje, PeriodoDia: Periodo});
                    
                    // Agora que criamos a linha, atualizamos a nossa variável para enxergar ela
                    Set(RegExcedenteAtual, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo))
                );
                
                // 4. Fazemos a soma e atualizamos o banco.
                // NOTA: No 2º argumento usamos o LookUp (evita o erro do Dataverse).
                // No 3º argumento usamos a Variável + Value() (Deixa muito rápido e dispensa dezenas de IsBlanks).
                Switch(
                    AssistenciaAtual,
                    "A1", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {A1: Value(RegExcedenteAtual.A1) + 1}),
                    "A2", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {A2: Value(RegExcedenteAtual.A2) + 1}),
                    "A3", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {A3: Value(RegExcedenteAtual.A3) + 1}),
                    "C1", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {C1: Value(RegExcedenteAtual.C1) + 1}),
                    "C2", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {C2: Value(RegExcedenteAtual.C2) + 1}),
                    "C3", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {C3: Value(RegExcedenteAtual.C3) + 1}),
                    
                    // Casos Duplos
                    "A3/A1", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegExcedenteAtual.A3) + 1,
                        A1: Value(RegExcedenteAtual.A1) + 1
                    }),
                    "C3/C1", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {
                        C3: Value(RegExcedenteAtual.C3) + 1,
                        C1: Value(RegExcedenteAtual.C1) + 1
                    }),
                    "A3/A2", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegExcedenteAtual.A3) + 1,
                        A2: Value(RegExcedenteAtual.A2) + 1
                    }),
                    "C3/C2", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {
                        C3: Value(RegExcedenteAtual.C3) + 1,
                        C2: Value(RegExcedenteAtual.C2) + 1
                    }),
                    "A3/A2-Casa", Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), {
                        A3: Value(RegExcedenteAtual.A3) + 1
                    })
                );
                /*
                //------------------------------------------------------------------------------------------
                // Registra na tabela Presenças_Excedentes um excedente na data atual e na assistência
                // Verificar se a data atual já existe na tabela Presenças_Excedentes
                Set(Hoje, Text(Today(), "[$-pt-BR]dd/mm/yyyy"));
                
                Set(ExistingRecord, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo));
                
                // Se não existir, criar um novo registro
                If(
                    IsBlank(ExistingRecord),
                    Patch(Excedentes, Defaults(Excedentes), {Data: Hoje, PeriodoDia: Periodo})
                );
                
                If(
                    AssistenciaAtual = "A1",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A1: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A1), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A1 + 1)}),
                    AssistenciaAtual = "A2",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A2: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A2), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A2 + 1)}),
                    AssistenciaAtual = "A3",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3 + 1)}),
                    AssistenciaAtual = "C1",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {C1: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C1), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C1 + 1)}),
                    AssistenciaAtual = "C2",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {C2: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C2), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C2 + 1)}),
                    AssistenciaAtual = "C3",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3 + 1)}),
                    AssistenciaAtual = "A3/A1",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3 + 1),
                             A1: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A1), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A1 + 1)}),
                    AssistenciaAtual = "C3/C1",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3 + 1),
                             C1: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C1), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C1 + 1)}),
                    AssistenciaAtual = "A3/A2",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3 + 1),
                             A2: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A2), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A2 + 1)}),
                    AssistenciaAtual = "C3/C2",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {C3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C3 + 1),
                             C2: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C2), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).C2 + 1)}),
                    AssistenciaAtual = "A3/A2-Casa",
                    Patch(Excedentes, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo), 
                            {A3: If(IsBlank(LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3), 1, LookUp(Excedentes, Data = Hoje && PeriodoDia = Periodo).A3 + 1)})
                );
                //------------------------------------------------------------------------------------------
                */
                //------------------------------------------------------------------------------------------
                //Salva na tabela Pessoas a data atual na coluna 'Ultima Assistência' (para poder fazer a
                //limpeza por tempo que não comparece à assistência.
                Patch(
                    Pessoas,
                    LookUp(Pessoas, 'ID Pessoa' = PessoaSelecionada),
                    {'Ultima Assistência': Today()}
                );
                //------------------------------------------------------------------------------------------
                
                //------------------------------------------------------------------------------------------
                //Salva na tabela Assistências a data atual na coluna 'Ultimo Comparecimento' (para poder
                //fazer a limpeza por tempo que não comparece à assistência.
                Patch(
                    Assistências,
                    LookUp(Assistências, 'ID Assistência' = AssistenciaSelecionada),
                    {'Ultimo Comparecimento': Today()}
                );
                //------------------------------------------------------------------------------------------
                
                UpdateContext({PopupConfirmaExcedente: false});
                
                Back();
            Size: =24
            Text: ="Sim"
            Visible: =PopupConfirmaExcedente
            Width: =157
            X: =Retangulo_Popup_Confirma_Presença.X + (Retangulo_Popup_Confirma_Presença.Width/4)*3 - Self.Width/2
            Y: =630
            ZIndex: =20

        Btn_Nao_Confirma_Excedente As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |-
                =UpdateContext({PopupConfirmaExcedente: false});
            Size: =24
            Text: ="Não"
            Visible: =PopupConfirmaExcedente
            Width: =157
            X: =Retangulo_Popup_Confirma_Presença.X + (Retangulo_Popup_Confirma_Presença.Width/4) - Self.Width/2
            Y: =630
            ZIndex: =21

    Timer1 As timer:
        AutoPause: =false
        AutoStart: =true
        Duration: =600
        Fill: =RGBA(0, 51, 102, 1)
        Height: =61
        HoverColor: =RGBA(255, 255, 255, 1)
        HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
        OnTimerEnd: |-
            =UpdateContext({ varPisca: !varPisca })
            //false
        Repeat: =true
        Start: |-
            =AssistenciaAtual in ["C3", "C3/C2"]
            //false
        Visible: =false
        Width: =64
        X: =656
        Y: =1384
        ZIndex: =36

    Popup_Encerrar_Mesmo_Dia As group:
        Height: =5
        minimumHeight: =5
        minimumWidth: =5
        Visible: =true
        Width: =5
        X: =148
        Y: =20
        ZIndex: =36

        Retangulo_Popup_Mesmo_Dia As rectangle:
            BorderColor: =RGBA(0, 89, 178, 1)
            Fill: =Color.White
            Height: =281
            Visible: =PopupDataMesmoDia
            Width: =500
            X: =Parent.Width/2 - Self.Width/2
            Y: =448
            ZIndex: =31

        lbl_Aviso_popup_Mesmo_Dia As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(255, 255, 255, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =Color.Red
            FontWeight: =FontWeight.Bold
            Height: =72
            Size: =21
            Text: ="Aviso"
            Visible: =PopupDataMesmoDia
            Width: =Retangulo_Popup_Mesmo_Dia.Width
            X: =Parent.Width/2 - Self.Width/2
            Y: =448
            ZIndex: =32

        lbl_Texto_popup_Mesmo_Dia As label:
            Align: =Align.Center
            BorderColor: =RGBA(0, 89, 178, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Height: =84
            Size: =21
            Text: ="Não é possível encerrar assistências realizadas no mesmo dia"
            Visible: =PopupDataMesmoDia
            Width: =Retangulo_Popup_Mesmo_Dia.Width
            X: =Parent.Width/2 - Self.Width/2
            Y: =525
            ZIndex: =33

        Btn_Ok_Mesmo_Dia As button:
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(0, 51, 102, 1)
            FocusedBorderColor: =ColorFade(Self.Fill, -75%)
            FontWeight: =FontWeight.Semibold
            Height: =55
            HoverColor: =RGBA(255, 255, 255, 1)
            HoverFill: =ColorFade(RGBA(0, 51, 102, 1), -20%)
            OnSelect: |-
                =UpdateContext({PopupDataMesmoDia: false})
            Size: =24
            Text: ="Ok"
            Visible: =PopupDataMesmoDia
            Width: =157
            X: |-
                =//Retangulo_Popup_Mesmo_Dia.X + (Retangulo_Popup_Mesmo_Dia.Width/4) - Self.Width/2
                //Parent.Width/2 - Self.Width/2
                Retangulo_Popup_Mesmo_Dia.X + (Retangulo_Popup_Mesmo_Dia.Width/2 - Self.Width/2)
            Y: =650
            ZIndex: =35

